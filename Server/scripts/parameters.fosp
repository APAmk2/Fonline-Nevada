                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   

import void PerkUp(Critter&cr,uint perk)from"perks";
import void PerkDown(Critter&cr,uint perk)from"perks";  

void changedParam_Hp(Critter&cr,uint,int oldValue)
{
	int curHp=cr.StatBase[(72)];
	if(curHp<=0&&cr.IsLife())
	cr.StatBase[(72)]=1;
	if(curHp<__DeadHitPoints&&not cr.IsDead())
	cr.StatBase[(72)]=__DeadHitPoints+1;
	if(curHp>cr.Stat[(7)])
	cr.StatBase[(72)]=cr.Stat[(7)];
}

void changedParam_Experience(Critter&cr,uint,int oldValue)
{
	int exp=cr.StatBase[(76)]-oldValue;
	if(exp>0)
	{
		uint level=cr.Stat[(77)];
		if(level>=__LevelCap&&not __LevelCapAddExperience)
		return;
		
		exp+=exp*(cr.Perk[(351)]*5)/100;
		cr.StatBase[(76)]=oldValue+exp;
		
		if(level>=__LevelCap)
		return;
		
		int perkUp=(cr.Trait[(564)]!=0?4:3);
		while(true)
		{
			if(cr.StatBase[(76)]>=NextLevelNeedExp(cr))
			{
				level++;
				cr.StatBase[(77)]++;
				
				cr.StatBase[(78)]+=5+cr.StatBase[(4)]*2;
				if(cr.Trait[(564)]!=0)
				cr.StatBase[(78)]+=5;
				
				cr.StatBase[(78)]+=cr.Perk[(319)]*2;
				if(cr.StatBase[(78)]>99)
				cr.StatBase[(78)]=99;
				if(__MaxLifeLevelSoftCap==0||uint(cr.Stat[(77)])<=__MaxLifeLevelSoftCap)
				cr.StatBase[(7)]+=2+cr.StatBase[(2)]/2+cr.Perk[(329)]*4;
				
				if((level%perkUp)==0)
				{
					cr.StatBase[(79)]=1;
				}
			}
			else
			break;
		}
	}
}

void changedParam_Perks(Critter&cr,uint perk,int oldValue)
{
	int curValue=cr.Param[perk];
	if(curValue>oldValue)
	for(uint i=0,j=curValue-oldValue;i<j;i++)
	PerkUp(cr,perk);
	else if(curValue<oldValue)
	for(uint i=0,j=oldValue-curValue;i<j;i++)
	PerkDown(cr,perk);
}

void changedParam_Hide(Critter&cr,uint,int oldValue)
{
	cr.RefreshVisible();
}

void changedParam_FastShot(Critter&cr,uint,int oldValue)
{
	cr.ModeBase[(538)]=(cr.Trait[(557)]!=0?1:0);
}

int NextLevelNeedExp(Critter&cr)
{
	int level=cr.Stat[(77)];
	return(((level)%2)!=0?(level)*((level)/2+1):(level)*(level)/2+(level)/2)*1000;
}

int getParamDialog_Intellect(Critter@master,Critter@slave,uint index)
{
	if((@master!=null))
	return master.Stat[(4)]+2*master.Perk[(350)];
	return 0;
}

int getParamDialog_Reputation(Critter@master,Critter@slave,uint index)
{
	if((@master!=null))
	{
		if(master.ReputationBase[index]==int(0x80000000))
		master.ReputationBase[index]=0;
		return master.ReputationBase[index];
	}
	return 0;
}                                                                    

void CritterGenerate(Critter&cr)    

{
	if(cr.ParamBase[(77)]<=0)
	cr.ParamBase[(77)]=1;
	
	if(cr.ParamBase[(552)]!=0)
	cr.ParamBase[(5)]+=1;
	if(cr.ParamBase[(551)]!=0)
	cr.ParamBase[(0)]+=2;
	if(cr.ParamBase[(560)]!=0)
	{
		cr.ParamBase[(206)]+=15;
		cr.ParamBase[(207)]+=15;
		cr.ParamBase[(214)]+=15;
		cr.ParamBase[(215)]+=15;
		cr.ParamBase[(200)]-=10;
		cr.ParamBase[(201)]-=10;
		cr.ParamBase[(202)]-=10;
		cr.ParamBase[(203)]-=10;
		cr.ParamBase[(204)]-=10;
		cr.ParamBase[(205)]-=10;
	}     
	
	cr.ParamBase[(200)]+=5+4*cr.ParamBase[(5)];
	cr.ParamBase[(201)]+=0+2*cr.ParamBase[(5)];
	cr.ParamBase[(202)]+=0+2*cr.ParamBase[(5)];
	cr.ParamBase[(203)]+=30+2*(cr.ParamBase[(5)]+cr.ParamBase[(0)]);
	cr.ParamBase[(204)]+=20+2*(cr.ParamBase[(5)]+cr.ParamBase[(0)]);
	cr.ParamBase[(205)]+=0+4*cr.ParamBase[(5)];
	cr.ParamBase[(206)]+=0+2*(cr.ParamBase[(1)]+cr.ParamBase[(4)]);
	cr.ParamBase[(207)]+=5+cr.ParamBase[(1)]+cr.ParamBase[(4)];
	cr.ParamBase[(208)]+=5+3*cr.ParamBase[(5)];
	cr.ParamBase[(209)]+=10+cr.ParamBase[(1)]+cr.ParamBase[(5)];
	cr.ParamBase[(210)]+=0+3*cr.ParamBase[(5)];
	cr.ParamBase[(211)]+=10+cr.ParamBase[(1)]+cr.ParamBase[(5)];
	cr.ParamBase[(212)]+=0+4*cr.ParamBase[(4)];
	cr.ParamBase[(213)]+=0+3*cr.ParamBase[(4)];
	cr.ParamBase[(214)]+=0+5*cr.ParamBase[(3)];
	cr.ParamBase[(215)]+=0+4*cr.ParamBase[(3)];
	cr.ParamBase[(216)]+=0+5*cr.ParamBase[(6)];
	cr.ParamBase[(217)]+=0+2*(cr.ParamBase[(2)]+cr.ParamBase[(4)]);
	
	if(cr.ParamBase[(226)]!=0)
	cr.ParamBase[cr.ParamBase[(226)]]+=20;
	if(cr.ParamBase[(227)]!=0)
	cr.ParamBase[cr.ParamBase[(227)]]+=20;
	if(cr.ParamBase[(228)]!=0)
	cr.ParamBase[cr.ParamBase[(228)]]+=20;
	
	if(cr.ParamBase[(550)]!=0)
	{
		cr.ParamBase[(30)]-=cr.ParamBase[(2)]*2;
		cr.ParamBase[(31)]-=cr.ParamBase[(2)]*5;
		cr.ParamBase[(13)]+=2;
	}
	if(cr.ParamBase[(551)]!=0)
	cr.ParamBase[(8)]-=2;
	if(cr.ParamBase[(555)]!=0)
	{
		cr.ParamBase[(9)]-=cr.ParamBase[(5)];
		cr.ParamBase[(12)]+=5;
	}
	if(cr.ParamBase[(556)]!=0)
	cr.ParamBase[(10)]+=4;
	if(cr.ParamBase[(554)]!=0)
	cr.ParamBase[(14)]+=10;
	if(cr.ParamBase[(556)]!=0)
	cr.ParamBase[(15)]-=30;
	if(cr.ParamBase[(557)]!=0)
	cr.ParamBase[(538)]=1;              
	
	cr.ParamBase[(7)]+=15;
	cr.ParamBase[(8)]+=5;
	cr.ParamBase[(72)]=cr.ParamBase[(7)];
	cr.ParamBase[(75)]=cr.ParamBase[(8)]*100;
}                                   

void NpcProcessLevel(Critter&npc)
{
	for(int i=0,j=npc.Stat[(77)];i<j;i++)
	{ 
		
	}
} 

uint CheckPlayerName(const string&name)
{
	
	if(name.length()<__MinNameLength||name.length()>__MaxNameLength)
	return(1009); 
	
	string allLetters=__ValidNameLettersCommon+__ValidNameLettersCulture1+__ValidNameLettersCulture2;
	for(uint i=0,j=name.length();i<j;i++)
	if(findFirst(allLetters,name[i])==-1)
	return(1036); 
	
	if(name[0]==" "||name[-1]==" ")
	return(1032);
	for(int i=0,j=name.length()-1;i<j;i++)
	if(name[i]==" "&&name[i+1]==" ")
	return(1033); 
	
	uint letters1=0;
	uint letters2=0;
	for(int i=0,j=name.length()-1;i<j;i++)
	{
		if(findFirst(__ValidNameLettersCulture1,name[i])!=-1)
		letters1++;
		else if(findFirst(__ValidNameLettersCulture2,name[i])!=-1)
		letters2++;
	}
	if(letters1>0&&letters2>0)
	return(1030); 
	
	if((letters1+letters2)*100/name.length()<70)
	return(1031); 
	
	return 0;
}
